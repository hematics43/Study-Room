<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Study Room</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
  <style>
    :root{--accent:#3b82f6;--bg:#f6f8fb;--card:#fff}
    body{margin:0;font-family:Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#111}
    header{padding:14px 18px;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.08);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap}
    header h1{margin:0;font-size:18px}
    .wrap{display:grid;grid-template-columns:1fr 320px;gap:16px;padding:16px;max-width:1200px;margin:0 auto}
    .card{background:var(--card);padding:12px;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,.05)}
    #editor{height:300px;background:#fff;border-radius:6px}
    .messages{height:240px;overflow:auto;padding:6px;background:#fafbfc;border-radius:6px;margin-bottom:8px}
    .msg{padding:6px 8px;border-radius:6px;margin-bottom:6px;background:#fff;word-break:break-word}
    .meta{font-size:12px;color:#555;margin-bottom:2px}
    .users div{padding:4px 0;border-bottom:1px solid #f0f0f0}
    input,button{padding:8px;border-radius:6px;border:1px solid #d1d5db;font-size:14px}
    input:focus{outline:none;border-color:var(--accent)}
    .btn{background:var(--accent);color:#fff;border:none;cursor:pointer;transition:.2s}
    .btn:hover{background:#2563eb}
    .composer{display:flex;gap:8px}
    footer{padding:12px;text-align:center;font-size:13px;color:#64748b}
    /* Modal for uploaded files */
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000}
    .modal-content{background:#fff;max-width:600px;width:90%;max-height:80%;overflow:auto;padding:16px;border-radius:8px;position:relative}
    .modal-content h3{margin-top:0}
    .close-btn{position:absolute;top:8px;right:12px;font-size:20px;cursor:pointer}
    .file-item{margin-bottom:10px}
    .file-item img{max-width:100%;border-radius:4px}
    @media(max-width:880px){
      .wrap{grid-template-columns:1fr}
      #editor{height:220px}
      .messages{height:180px}
    }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ”¥ Study Room</h1>
    <div id="roomLabel" style="font-size:14px;color:#444"></div>
  </header>

  <div class="wrap">
    <div>
      <div class="card" style="margin-bottom:14px">
        <div id="toolbar"></div>
        <div id="editor"></div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap">
          <input id="displayName" placeholder="Your name" style="flex:1 1 120px" />
          <input id="roomCode" placeholder="Room code (or leave blank)" style="flex:1 1 120px" />
          <button id="joinBtn" class="btn">Join Room</button>
          <button id="saveBtn" class="btn">ðŸ’¾ Save</button>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-top:0">ðŸ’¬ Chat</h3>
        <div id="messages" class="messages"></div>
        <div class="composer">
          <input id="chatInput" placeholder="Type a message..." style="flex:1" />
          <button id="sendBtn" class="btn">Send</button>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input type="file" id="fileInput" />
          <button id="uploadBtn" class="btn">â¬† Upload</button>
          <button id="filesBtn" class="btn">ðŸ“‚ Files</button>
        </div>
      </div>
    </div>

    <div>
      <div class="card">
        <h3 style="margin-top:0">ðŸ‘¥ People Online</h3>
        <div id="users" class="users"></div>
      </div>
    </div>
  </div>

  <footer>Built with Firebase Realtime Database + Firebase Storage + Quill</footer>

  <!-- Modal for file manager -->
  <div id="fileModal" class="modal">
    <div class="modal-content">
      <span id="closeModal" class="close-btn">&times;</span>
      <h3>ðŸ“‚ Uploaded Files</h3>
      <div id="fileList"></div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-storage-compat.js"></script>
  <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
  <script>
    // --- ðŸ”¥ Firebase config ---
    const firebaseConfig = {
      apiKey: "AIzaSyBkJMs46haewzuH0LdwtvfMg2LZeRuE1mk",
      authDomain: "studentroom-a1650.firebaseapp.com",
      databaseURL: "https://studentroom-a1650-default-rtdb.asia-southeast1.firebasedatabase.app/",
      projectId: "studentroom-a1650",
      storageBucket: "studentroom-a1650.appspot.com",
      messagingSenderId: "515724899947",
      appId: "1:515724899947:web:e985abc877872a2506a32e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    // --- Quill setup ---
    const quill = new Quill('#editor', {
      modules: { toolbar: [['bold','italic','underline'],[{list:'ordered'},{list:'bullet'}],['link']] },
      theme: 'snow'
    });

    // Local auto-save
    const draft = localStorage.getItem("studyroom-draft");
    if (draft) { try { quill.setContents(JSON.parse(draft)); } catch(e){} }
    quill.on("text-change", () => {
      localStorage.setItem("studyroom-draft", JSON.stringify(quill.getContents()));
    });

    // --- State ---
    let joined = false, userId = null, userName = null, room = null, suppress = false;

    document.getElementById("joinBtn").onclick = () => {
      if (joined) return;
      userName = document.getElementById("displayName").value.trim() || "Anonymous";
      room = document.getElementById("roomCode").value.trim();
      const qs = new URLSearchParams(location.search);
      if (!room) {
        room = qs.get("room") || "room-" + Math.random().toString(36).slice(2, 8);
        history.replaceState(null, "", "?room=" + room);
      } else history.replaceState(null, "", "?room=" + room);
      document.getElementById("roomLabel").textContent = "Room: " + room;
      userId = Math.random().toString(36).slice(2,9);
      joinRoom();
    };

    function joinRoom(){
      joined = true;
      // Presence
      const userRef = db.ref(`rooms/${room}/presence/${userId}`);
      userRef.set(userName); userRef.onDisconnect().remove();
      db.ref(`rooms/${room}/presence`).on("value", snap => {
        const usersEl = document.getElementById("users"); usersEl.innerHTML = "";
        snap.forEach(c => { const d = document.createElement("div"); d.textContent = c.val(); usersEl.appendChild(d); });
      });

      // Chat
      db.ref(`rooms/${room}/chat`).limitToLast(50).on("child_added", snap => addMessage(snap.val().name, snap.val().text, snap.val().ts));
      document.getElementById("sendBtn").onclick = () => {
        const txt = document.getElementById("chatInput").value.trim(); if (!txt) return;
        db.ref(`rooms/${room}/chat`).push({ name:userName, text:txt, ts:Date.now() }); document.getElementById("chatInput").value = "";
      };

      // File upload
      document.getElementById("uploadBtn").onclick = async () => {
        const file = document.getElementById("fileInput").files[0];
        if (!file) return alert("Choose a file first.");
        const storageRef = storage.ref(`rooms/${room}/uploads/${Date.now()}_${file.name}`);
        await storageRef.put(file);
        const url = await storageRef.getDownloadURL();
        const fileData = { name:file.name, type:file.type, url:url, user:userName, ts:Date.now() };
        db.ref(`rooms/${room}/files`).push(fileData);
        db.ref(`rooms/${room}/chat`).push({ name:userName, text:`ðŸ“Ž <a href="${url}" target="_blank">${file.name}</a>`, ts:Date.now() });
        document.getElementById("fileInput").value = "";
        alert("File uploaded!");
      };

      // File modal
      document.getElementById("filesBtn").onclick = () => { document.getElementById("fileModal").style.display = "flex"; };
      document.getElementById("closeModal").onclick = () => { document.getElementById("fileModal").style.display = "none"; };
      db.ref(`rooms/${room}/files`).on("child_added", snap => {
        const f = snap.val();
        const item = document.createElement("div"); item.className="file-item";
        if (f.type && f.type.startsWith("image/")) item.innerHTML = `<div><strong>${f.name}</strong> by ${f.user}</div><img src="${f.url}"/>`;
        else item.innerHTML = `<div><strong><a href="${f.url}" target="_blank">${f.name}</a></strong> by ${f.user}</div>`;
        document.getElementById("fileList").appendChild(item);
      });

      // Doc sync
      const docRef = db.ref(`rooms/${room}/doc`), opsRef = db.ref(`rooms/${room}/ops`);
      docRef.once("value").then(snap => { if (snap.val()) quill.setContents(snap.val()); });
      opsRef.on("child_added", snap => { const op = snap.val(); if (op && op.user !== userId){ suppress=true; quill.updateContents(op.delta); suppress=false; }});
      quill.on("text-change", (delta, old, src) => { if(!joined||suppress||src!=="user")return; opsRef.push({delta:delta,user:userId}); docRef.set(quill.getContents()); });

      // Save as text
      document.getElementById("saveBtn").onclick = () => {
        const blob = new Blob([quill.getText()], {type:"text/plain"});
        const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`${room}_notes.txt`; a.click();
      };
    }

    function addMessage(name, text, ts){
      const d=document.createElement("div"); d.className="msg";
      d.innerHTML=`<div class="meta">${name} â€¢ ${new Date(ts).toLocaleTimeString()}</div><div>${text}</div>`;
      const m=document.getElementById("messages"); m.appendChild(d); m.scrollTop=m.scrollHeight;
    }
  </script>
</body>
</html>
