<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Study Room</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
  <style>
    :root{--accent:#3b82f6;--bg:#f6f8fb;--card:#fff}
    body{margin:0;font-family:Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#111}
    header{padding:14px 18px;background:#fff;box-shadow:0 1px 4px rgba(0,0,0,.08);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap}
    header h1{margin:0;font-size:18px}
    .wrap{display:grid;grid-template-columns:1fr 320px;gap:16px;padding:16px;max-width:1200px;margin:0 auto}
    .card{background:var(--card);padding:12px;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,.05)}
    #editor{height:300px;background:#fff;border-radius:6px}
    .messages{height:240px;overflow:auto;padding:6px;background:#fafbfc;border-radius:6px;margin-bottom:8px}
    .msg{padding:6px 8px;border-radius:6px;margin-bottom:6px;background:#fff;word-break:break-word}
    .meta{font-size:12px;color:#555;margin-bottom:2px}
    .users div{padding:4px 0;border-bottom:1px solid #f0f0f0}
    input,button{padding:8px;border-radius:6px;border:1px solid #d1d5db;font-size:14px}
    input:focus{outline:none;border-color:var(--accent)}
    .btn{background:var(--accent);color:#fff;border:none;cursor:pointer;transition:.2s}
    .btn:hover{background:#2563eb}
    .composer{display:flex;gap:8px}
    footer{padding:12px;text-align:center;font-size:13px;color:#64748b}
    .file-preview{margin-top:10px;max-height:150px;overflow:auto;border:1px solid #ddd;padding:6px;border-radius:6px;background:#fafafa}
    .file-preview img{max-width:100%;border-radius:4px;margin-bottom:6px}
    @media(max-width:880px){
      .wrap{grid-template-columns:1fr}
      #editor{height:220px}
      .messages{height:180px}
    }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ”¥ Study Room</h1>
    <div id="roomLabel" style="font-size:14px;color:#444"></div>
  </header>

  <div class="wrap">
    <div>
      <div class="card" style="margin-bottom:14px">
        <div id="toolbar"></div>
        <div id="editor"></div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:10px;flex-wrap:wrap">
          <input id="displayName" placeholder="Your name" style="flex:1 1 120px" />
          <input id="roomCode" placeholder="Room code (or leave blank)" style="flex:1 1 120px" />
          <button id="joinBtn" class="btn">Join Room</button>
          <button id="saveBtn" class="btn">ðŸ’¾ Save</button>
        </div>
      </div>
      <div class="card">
        <h3 style="margin-top:0">ðŸ’¬ Chat</h3>
        <div id="messages" class="messages"></div>
        <div class="composer">
          <input id="chatInput" placeholder="Type a message..." style="flex:1" />
          <button id="sendBtn" class="btn">Send</button>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input type="file" id="fileInput" />
          <button id="uploadBtn" class="btn">â¬† Upload</button>
        </div>
        <div id="preview" class="file-preview" style="display:none"></div>
      </div>
    </div>

    <div>
      <div class="card">
        <h3 style="margin-top:0">ðŸ‘¥ People Online</h3>
        <div id="users" class="users"></div>
      </div>
    </div>
  </div>

  <footer>Built with Firebase Realtime Database + Firebase Storage + Quill</footer>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-storage-compat.js"></script>
  <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
  <script>
    // --- ðŸ”¥ Firebase config ---
    const firebaseConfig = {
      apiKey: "AIzaSyBkJMs46haewzuH0LdwtvfMg2LZeRuE1mk",
      authDomain: "studentroom-a1650.firebaseapp.com",
      databaseURL: "https://studentroom-a1650-default-rtdb.asia-southeast1.firebasedatabase.app/",
      projectId: "studentroom-a1650",
      storageBucket: "studentroom-a1650.appspot.com",
      messagingSenderId: "515724899947",
      appId: "1:515724899947:web:e985abc877872a2506a32e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    // --- Quill setup ---
    const quill = new Quill('#editor', {
      modules: { toolbar: [['bold','italic','underline'],[{list:'ordered'},{list:'bullet'}],['link']] },
      theme: 'snow'
    });

    // Restore local draft if exists
    const draft = localStorage.getItem("studyroom-draft");
    if (draft) {
      try { quill.setContents(JSON.parse(draft)); } catch(e){}
    }

    // Auto-save locally every change
    quill.on("text-change", () => {
      localStorage.setItem("studyroom-draft", JSON.stringify(quill.getContents()));
    });

    // --- State ---
    let joined = false;
    let userId = null;
    let userName = null;
    let room = null;
    let suppress = false;

    // --- Join ---
    document.getElementById("joinBtn").onclick = () => {
      if (joined) return;
      userName = document.getElementById("displayName").value.trim() || "Anonymous";
      room = document.getElementById("roomCode").value.trim();

      const qs = new URLSearchParams(location.search);
      if (!room) {
        room = qs.get("room");
        if (!room) {
          room = "room-" + Math.random().toString(36).slice(2, 8);
          history.replaceState(null, "", "?room=" + room);
        }
      } else {
        history.replaceState(null, "", "?room=" + room);
      }

      document.getElementById("roomLabel").textContent = "Room: " + room;
      userId = Math.random().toString(36).slice(2,9);
      joinRoom();
    };

    function joinRoom(){
      joined = true;

      // Presence
      const userRef = db.ref(`rooms/${room}/presence/${userId}`);
      userRef.set(userName);
      userRef.onDisconnect().remove();
      db.ref(`rooms/${room}/presence`).on("value", snap => {
        const usersEl = document.getElementById("users");
        usersEl.innerHTML = "";
        snap.forEach(c => {
          const div = document.createElement("div");
          div.textContent = c.val();
          usersEl.appendChild(div);
        });
      });

      // Chat listen
      db.ref(`rooms/${room}/chat`).limitToLast(50).on("child_added", snap => {
        const m = snap.val();
        addMessage(m.name, m.text, m.ts);
      });

      // Chat send
      document.getElementById("sendBtn").onclick = () => {
        const txt = document.getElementById("chatInput").value.trim();
        if (!txt) return;
        db.ref(`rooms/${room}/chat`).push({ name:userName, text:txt, ts:Date.now() });
        document.getElementById("chatInput").value = "";
      };

      // File preview
      document.getElementById("fileInput").onchange = e => {
        const file = e.target.files[0];
        const previewEl = document.getElementById("preview");
        previewEl.innerHTML = "";
        if (file) {
          if (file.type.startsWith("image/")) {
            const img = document.createElement("img");
            img.src = URL.createObjectURL(file);
            previewEl.appendChild(img);
          } else {
            previewEl.textContent = "ðŸ“„ " + file.name;
          }
          previewEl.style.display = "block";
        } else {
          previewEl.style.display = "none";
        }
      };

      // File upload
      document.getElementById("uploadBtn").onclick = async () => {
        const file = document.getElementById("fileInput").files[0];
        if (!file) return alert("Choose a file first.");
        const storageRef = storage.ref(`rooms/${room}/uploads/${Date.now()}_${file.name}`);
        await storageRef.put(file);
        const url = await storageRef.getDownloadURL();
        db.ref(`rooms/${room}/chat`).push({
          name:userName,
          text:`ðŸ“Ž <a href="${url}" target="_blank">${file.name}</a>`,
          ts:Date.now()
        });
        document.getElementById("fileInput").value = "";
        document.getElementById("preview").style.display = "none";
      };

      // Doc sync
      const docRef = db.ref(`rooms/${room}/doc`);
      const opsRef = db.ref(`rooms/${room}/ops`);

      docRef.once("value").then(snap => {
        const val = snap.val();
        if (val) quill.setContents(val);
      });

      opsRef.on("child_added", snap => {
        const op = snap.val();
        if (op && op.user !== userId) {
          suppress = true;
          quill.updateContents(op.delta);
          suppress = false;
        }
      });

      quill.on("text-change", (delta, old, source) => {
        if (!joined || suppress || source !== "user") return;
        opsRef.push({ delta: delta, user: userId });
        docRef.set(quill.getContents());
      });

      // Save as file
      document.getElementById("saveBtn").onclick = () => {
        const contents = quill.getText();
        const blob = new Blob([contents], {type: "text/plain"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `${room}_notes.txt`;
        a.click();
      };
    }

    // Chat UI
    function addMessage(name, text, ts){
      const div = document.createElement("div");
      div.className = "msg";
      div.innerHTML = `<div class="meta">${name} â€¢ ${new Date(ts).toLocaleTimeString()}</div><div>${text}</div>`;
      const messagesEl = document.getElementById("messages");
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
  </script>
</body>
</html>
